# Настройка Supabase для Life-Guide

## Шаг 1: Создание проекта в Supabase

1. Перейдите на [https://supabase.com/](https://supabase.com/) и войдите в свой аккаунт или зарегистрируйтесь.
2. Нажмите кнопку "New Project".
3. Введите название проекта (например, "life-guide").
4. Выберите регион, ближайший к вашему местоположению.
5. Установите надежный пароль для базы данных.
6. Нажмите "Create new project".

## Шаг 2: Создание таблиц

1. После создания проекта перейдите в раздел "SQL Editor".
2. Создайте новый запрос и вставьте содержимое файла `docs/supabase-setup.sql` из проекта.
3. Нажмите "Run" для выполнения SQL-запроса и создания таблиц.

> **Важно**: Таблица `users` должна содержать колонку `email`. Если вы видите ошибку `column users.email does not exist`, это означает, что таблицы не были созданы правильно.

### Структура таблиц

#### Таблица `users`

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Уникальный идентификатор пользователя |
| name | TEXT | Имя пользователя |
| email | TEXT | Email пользователя (уникальный) |
| password | TEXT | Хешированный пароль пользователя |
| salt | TEXT | Соль для хеширования пароля |
| role | TEXT | Роль пользователя ('user' или 'admin') с проверкой на допустимые значения |
| image | TEXT | URL изображения профиля (опционально) |
| created_at | TIMESTAMP | Дата и время создания пользователя |

#### Таблица `advices`

| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Уникальный идентификатор совета |
| category | TEXT | Категория совета ('psychology', 'study' или 'life') с проверкой на допустимые значения |
| question | TEXT | Вопрос или тема совета |
| answer | TEXT | Ответ или содержание совета |
| author_id | UUID | Идентификатор автора совета (опционально) |
| created_at | TIMESTAMP | Дата и время создания совета |

## Шаг 3: Настройка аутентификации

1. Перейдите в раздел "Authentication" -> "Providers".
2. Включите Email/Password аутентификацию.
3. Если вы хотите использовать OAuth, настройте Google и GitHub провайдеры:
   - Для Google: [Инструкция по настройке Google OAuth](https://supabase.com/docs/guides/auth/social-login/auth-google)
   - Для GitHub: [Инструкция по настройке GitHub OAuth](https://supabase.com/docs/guides/auth/social-login/auth-github)

## Шаг 4: Получение API ключей

1. Перейдите в раздел "Project Settings" -> "API".
2. Скопируйте "Project URL" и вставьте его в файл `.env.local` в качестве значения для `NEXT_PUBLIC_SUPABASE_URL`.
3. Скопируйте "anon public" ключ и вставьте его в файл `.env.local` в качестве значения для `NEXT_PUBLIC_SUPABASE_ANON_KEY`.

## Шаг 5: Настройка Row Level Security (RLS)

1. Перейдите в раздел "Authentication" -> "Policies".
2. Для каждой таблицы настройте политики доступа:

### Политики для таблицы users:
- Чтение: Разрешить всем пользователям читать свои данные и администраторам читать все данные.
- Создание: Разрешить всем создавать пользователей (для регистрации).
- Обновление: Разрешить пользователям обновлять только свои данные и администраторам обновлять все данные.
- Удаление: Разрешить только администраторам удалять пользователей.

### Политики для таблицы advices:
- Чтение: Разрешить всем читать все советы.
- Создание: Разрешить аутентифицированным пользователям создавать советы.
- Обновление: Разрешить пользователям обновлять только свои советы и администраторам обновлять все советы.
- Удаление: Разрешить пользователям удалять только свои советы и администраторам удалять все советы.

## Шаг 6: Настройка переменных окружения

Обновите файл `.env.local` с правильными значениями:

```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://your-supabase-url.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-supabase-service-role-key
```

## Шаг 7: Добавление базовых советов

Для добавления базовых советов в приложение:

1. Файл `docs/supabase-setup.sql` уже содержит команды для добавления 15 базовых советов в трех категориях:
   - 5 советов по психологии
   - 5 советов по учебе
   - 5 советов по организации жизни

2. Если вы хотите добавить советы вручную, используйте файл `docs/initial-advices.json` и импортируйте его через интерфейс Supabase или через API.

3. Для программного импорта советов можно использовать скрипт `docs/import-advices.js`:
   ```bash
   pnpm add @supabase/supabase-js dotenv
   node docs/import-advices.js
   ```

## Шаг 8: Запуск приложения

После настройки Supabase и обновления переменных окружения запустите приложение:

```bash
pnpm run dev
```

Теперь регистрация, вход и работа с советами должны работать корректно.

## Устранение неполадок

### Проблема: Ошибка "Таблица не существует"

**Решение:**
1. Убедитесь, что вы выполнили SQL-скрипт из файла `docs/supabase-setup.sql`.
2. Проверьте, что таблицы созданы в панели управления Supabase в разделе "Table Editor".

### Проблема: Ошибка подключения к Supabase

**Решение:**
1. Проверьте правильность URL и ключа в файле `.env.local`.
2. Убедитесь, что файл `.env.local` находится в корне проекта.
3. Перезапустите сервер разработки после изменения файла `.env.local`.

### Проблема: Ошибка при регистрации пользователя

**Решение:**
1. Проверьте консоль браузера на наличие ошибок.
2. Убедитесь, что таблица `users` имеет правильную структуру.
3. Проверьте, что у анонимного пользователя есть права на вставку в таблицу `users`.
4. Для регистрации администратора используйте ключ: `12283Ara`.
